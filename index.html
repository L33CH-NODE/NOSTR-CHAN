<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOSTRchan - Nostr-based Anonymous Forum</title>
  <script src="https://unpkg.com/nostr-tools@1.17.0/lib/nostr.bundle.js"></script>
  <script src="https://unpkg.com/dompurify@3.1.6/dist/purify.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #FFFFEE; padding: 20px; color: #000; }
    .board, .thread, .post { background: #F0E0D6; padding: 10px; margin: 5px 0; border: 1px solid #D6D6D6; }
    h1, h2, h3 { color: #800000; }
    a { color: #0000EE; text-decoration: none; }
    a:hover { color: #DD0000; }
    .post-form textarea { width: 100%; height: 100px; background: #F0E0D6; border: 1px solid #D6D6D6; }
    .post-form button { padding: 10px; background: #F0E0D6; color: #800000; border: 1px solid #D6D6D6; cursor: pointer; }
    .post-form button:hover { background: #E0D0C6; }
    .post-form button:disabled { cursor: not-allowed; background: #E0D0C6; color: #A0A0A0; }
    .board-category ul { list-style: none; padding: 0; display: flex; flex-wrap: wrap; }
    .board-category li { margin-right: 10px; cursor: pointer; }
    #loading { color: #800000; font-weight: bold; }
    .back-button { padding: 8px; background: #F0E0D6; color: #800000; border: 1px solid #D6D6D6; cursor: pointer; margin-bottom: 10px; }
    #message-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #DD0000; color: white; padding: 15px 30px; border-radius: 8px; display: none; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Welcome to NOSTRchan</h1>
  <div style="margin-bottom:10px;">
    <button class="back-button" onclick="toggleSettings()">Settings</button>
  </div>
  <div id="loading" style="display:none;">Loading...</div>
  <div id="message-box"></div>

  <div id="settings-panel" style="display:none; background:#F0E0D6; padding:10px; border:1px solid #D6D6D6; margin-bottom:10px;">
    <h2>Configuration</h2>
    <div style="margin-bottom:6px;">
      <label for="relay-list"><strong>Relays (one per line)</strong></label>
      <textarea id="relay-list" style="width:100%; height:120px; background:#FFFFEE;"></textarea>
    </div>
    <div style="margin-top:8px;">
      <label for="publish-count"><strong>Publish subset size</strong></label>
      <input type="number" id="publish-count" min="1" max="10" value="3" style="width:60px;">
    </div>
    <div style="margin-top:8px;">
      <button class="back-button" onclick="saveSettings()">Save</button>
      <button class="back-button" onclick="testRelays()">Test Relays</button>
      <button class="back-button" onclick="toggleSettings()">Close</button>
    </div>
    <div id="relay-status" style="margin-top:8px;"></div>
  </div>

  <div class="board-list">
    <h2>Boards</h2>
    <div id="boards"></div>
  </div>
  <div class="thread-list" style="display:none;">
    <button class="back-button" onclick="goBackToBoards()">Back to Boards</button>
    <h2>Threads in <span id="current-board"></span></h2>
    <ul id="threads"></ul>
    <div class="post-form">
      <h3>Create New Thread</h3>
      <textarea id="new-thread-content" placeholder="Thread content"></textarea>
      <input type="file" id="thread-image" accept="image/*">
      <button id="thread-post-button" onclick="createThread()">Post Thread</button>
    </div>
  </div>
  <div class="post-list" style="display:none;">
    <button class="back-button" onclick="goBackToThreads()">Back to Threads</button>
    <h2>Posts in Thread</h2>
    <ul id="posts"></ul>
    <div class="post-form">
      <h3>Reply to Thread</h3>
      <textarea id="new-post-content" placeholder="Reply content"></textarea>
      <input type="file" id="post-image" accept="image/*">
      <button id="reply-post-button" onclick="createPost()">Post Reply</button>
    </div>
  </div>

  <script>
    function showMessage(message, duration=3000) {
      const msgBox = document.getElementById('message-box');
      msgBox.innerText = message;
      msgBox.style.display = 'block';
      setTimeout(() => msgBox.style.display = 'none', duration);
    }

    // Default, privacy-optimized relay set
    const DEFAULT_RELAYS = [
      'wss://relay.damus.io',
      'wss://nos.lol',
      'wss://eden.nostr.land',
      'wss://relay.snort.social',
      'wss://relay.primal.net',
      'wss://nostr.fmt.wiz.biz',
      'wss://offchain.pub',
      'wss://nostr.wine',
      'wss://relay.current.fyi',
      'wss://purplepag.es',
      'wss://nostr.mom',
      'wss://relay.orangepill.dev',
      'wss://relay.nostr.bg',
      'wss://nostr.zebedee.cloud',
      'wss://nostr.zaprite.com',
      'wss://nostr-pub.wellorder.net'
    ];

    // Working relay list (starts from defaults, can be overridden by user)
    let RELAYS = DEFAULT_RELAYS.slice();
    let publishSubsetCount = Number(localStorage.getItem('publishSubsetCount')) || 3;

    function normalizeRelayUrl(url) {
      try { return new URL(url).toString().replace(/\/$/, ''); } catch { return ''; }
    }

    function loadRelaysFromStorage() {
      try {
        const raw = localStorage.getItem('relays');
        if (!raw) return;
        const list = raw.split(/[\n,\s]+/).map(normalizeRelayUrl).filter(Boolean);
        const unique = Array.from(new Set(list));
        if (unique.length) {
          RELAYS = unique;
        }
      } catch {}
    }

    function getPublishCount() {
      const n = Number(localStorage.getItem('publishSubsetCount'));
      return Number.isFinite(n) && n > 0 ? Math.floor(n) : publishSubsetCount;
    }

    function pickRandomSubset(array, count) {
      if (array.length <= count) return array.slice();
      const copy = array.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const t = copy[i]; copy[i] = copy[j]; copy[j] = t;
      }
      return copy.slice(0, count);
    }

    function getWriteRelays() {
      return pickRandomSubset(RELAYS, getPublishCount());
    }

    let pool = null;
    let currentSub = null;
    let currentBoard = null;
    let currentThread = null;

    const BOARDS = [
      { category: 'General', boards: [
        { name: '/b/ - Random', pubkey: '64d60e7e1081559c5d0e2e9871790ae3d11b3d67f1b74f3e6c8880e60d3d5f5a' }
      ]}
    ];

    async function uploadImage(file) {
      const formData = new FormData();
      formData.append('file', file);
      const res = await fetch('https://nostr.build/api/v2/upload/files', { method: 'POST', body: formData });
      if (!res.ok) throw new Error('Upload failed');
      const result = await res.json();
      return result?.data?.[0]?.url;
    }

    async function generateTempKeypair() {
      const privkey = NostrTools.generatePrivateKey();
      const pubkey = NostrTools.getPublicKey(privkey);
      return { privkey, pubkey };
    }

    async function ensureRelayConnections() {
      pool = new NostrTools.SimplePool();
      await Promise.allSettled(RELAYS.map(r => pool.ensureRelay(r)));
    }

    function formatTimestamp(ts) { return new Date(ts*1000).toLocaleString(); }

    function loadBoards() {
      const boardsDiv = document.getElementById('boards');
      boardsDiv.innerHTML = '';
      BOARDS.forEach(cat => {
        const div = document.createElement('div');
        div.className = 'board-category';
        div.innerHTML = `<h3>${cat.category}</h3>`;
        const ul = document.createElement('ul');
        cat.boards.forEach(board => {
          const li = document.createElement('li');
          li.className = 'board';
          li.innerText = board.name;
          li.onclick = () => loadThreads(board);
          ul.appendChild(li);
        });
        div.appendChild(ul);
        boardsDiv.appendChild(div);
      });
    }

    function unsubscribe() { if (currentSub) { currentSub.unsub(); currentSub = null; } }

    function goBackToBoards() {
      unsubscribe();
      document.querySelector('.board-list').style.display = 'block';
      document.querySelector('.thread-list').style.display = 'none';
      document.querySelector('.post-list').style.display = 'none';
      currentBoard = null; currentThread = null;
      document.getElementById('loading').style.display = 'none';
    }

    function goBackToThreads() {
      unsubscribe();
      document.querySelector('.thread-list').style.display = 'block';
      document.querySelector('.post-list').style.display = 'none';
      currentThread = null;
      loadThreads(currentBoard);
    }

    async function loadThreads(board) {
      currentBoard = board;
      document.getElementById('current-board').innerText = board.name;
      document.querySelector('.board-list').style.display = 'none';
      document.querySelector('.thread-list').style.display = 'block';
      document.querySelector('.post-list').style.display = 'none';
      document.getElementById('loading').style.display = 'block';

      const threadsContainer = document.getElementById('threads');
      threadsContainer.innerHTML = '';
      unsubscribe();
      let events = [];
      currentSub = pool.sub(RELAYS, [{ kinds:[1], '#board':[board.pubkey], '#t':['thread'], limit:20 }]);
      currentSub.on('event', ev => { if (!document.getElementById(ev.id)) events.push(ev); });
      currentSub.on('eose', () => {
        events.sort((a,b)=>b.created_at-a.created_at).forEach(ev=>renderThread(ev,'append'));
        currentSub.on('event', ev => { if (!document.getElementById(ev.id)) renderThread(ev,'prepend'); });
        document.getElementById('loading').style.display = 'none';
      });
    }

    function renderThread(ev, mode='append') {
      const li = document.createElement('li');
      li.className = 'thread';
      li.id = ev.id;
      li.innerHTML = `<p><small>${formatTimestamp(ev.created_at)}</small></p><p>${DOMPurify.sanitize(ev.content)}</p>`;
      li.onclick = () => loadPosts(ev);
      const cont = document.getElementById('threads');
      mode==='prepend'? cont.prepend(li): cont.appendChild(li);
    }

    async function loadPosts(thread) {
      currentThread = thread;
      document.querySelector('.thread-list').style.display = 'none';
      document.querySelector('.post-list').style.display = 'block';
      document.getElementById('loading').style.display = 'block';
      const cont = document.getElementById('posts');
      cont.innerHTML='';
      const orig = document.createElement('li');
      orig.className='post';
      orig.innerHTML = `<h3>Original Post</h3><p><small>${formatTimestamp(thread.created_at)}</small></p><p>${DOMPurify.sanitize(thread.content)}</p>`;
      cont.appendChild(orig);
      unsubscribe();
      let events=[];
      currentSub = pool.sub(RELAYS,[{ kinds:[1], '#e':[thread.id]}]);
      currentSub.on('event', ev=>{ if(ev.id!==thread.id&&!document.getElementById(ev.id)) events.push(ev); });
      currentSub.on('eose', ()=>{
        events.sort((a,b)=>a.created_at-b.created_at).forEach(ev=>renderPost(ev));
        currentSub.on('event', ev=>{ if(ev.id!==thread.id&&!document.getElementById(ev.id)) renderPost(ev); });
        document.getElementById('loading').style.display = 'none';
      });
    }

    function renderPost(ev) {
      const li = document.createElement('li');
      li.className='post';
      li.id=ev.id;
      li.innerHTML=`<p><small>${formatTimestamp(ev.created_at)}</small></p><p>${DOMPurify.sanitize(ev.content)}</p>`;
      document.getElementById('posts').appendChild(li);
    }

    async function createThread() {
      const content=document.getElementById('new-thread-content').value;
      const imageFile=document.getElementById('thread-image').files[0];
      const btn=document.getElementById('thread-post-button');
      if(!content&&!imageFile){showMessage('Thread content or image required');return;}
      btn.disabled=true;
      try{
        const tags=[['board',currentBoard.pubkey],['t','thread']];
        if(imageFile){ btn.innerText='Uploading...'; const url=await uploadImage(imageFile); if(url) tags.push(['image',url]); }
        btn.innerText='Posting...';
        const {privkey}=await generateTempKeypair();
        const ev={kind:1,pubkey:NostrTools.getPublicKey(privkey),created_at:Math.floor(Date.now()/1000),tags,content};
        const signed=NostrTools.finalizeEvent(ev,privkey);
        const pubs=pool.publish(getWriteRelays(),signed);
        const results=await Promise.allSettled(pubs);
        if(results.some(r=>r.status==='fulfilled')) showMessage('Thread posted!'); else throw new Error('No relays accepted');
        document.getElementById('new-thread-content').value='';
        document.getElementById('thread-image').value='';
      }catch(e){console.error(e);showMessage('Failed: '+e.message);}finally{btn.disabled=false;btn.innerText='Post Thread';}
    }

    async function createPost() {
      const content=document.getElementById('new-post-content').value;
      const imageFile=document.getElementById('post-image').files[0];
      const btn=document.getElementById('reply-post-button');
      if(!content&&!imageFile){showMessage('Reply content or image required');return;}
      btn.disabled=true;
      try{
        // Remove relay URL from 'e' tag for privacy; keep marker as 'reply'
        const tags=[['e',currentThread.id,'','reply']];
        if(imageFile){ btn.innerText='Uploading...'; const url=await uploadImage(imageFile); if(url) tags.push(['image',url]); }
        btn.innerText='Posting...';
        const {privkey}=await generateTempKeypair();
        const ev={kind:1,pubkey:NostrTools.getPublicKey(privkey),created_at:Math.floor(Date.now()/1000),tags,content};
        const signed=NostrTools.finalizeEvent(ev,privkey);
        const pubs=pool.publish(getWriteRelays(),signed);
        const results=await Promise.allSettled(pubs);
        if(results.some(r=>r.status==='fulfilled')) showMessage('Reply posted!'); else throw new Error('No relays accepted');
        document.getElementById('new-post-content').value='';
        document.getElementById('post-image').value='';
      }catch(e){console.error(e);showMessage('Failed: '+e.message);}finally{btn.disabled=false;btn.innerText='Post Reply';}
    }

    function toggleSettings() {
      const panel = document.getElementById('settings-panel');
      const isOpen = panel.style.display !== 'none';
      panel.style.display = isOpen ? 'none' : 'block';
      if (!isOpen) populateSettingsForm();
    }

    function populateSettingsForm() {
      const textarea = document.getElementById('relay-list');
      textarea.value = RELAYS.join('\n');
      document.getElementById('publish-count').value = getPublishCount();
      document.getElementById('relay-status').innerHTML = '';
    }

    async function saveSettings() {
      const textarea = document.getElementById('relay-list');
      const countEl = document.getElementById('publish-count');
      const raw = textarea.value || '';
      const list = raw.split(/[\n,\s]+/).map(normalizeRelayUrl).filter(Boolean);
      const unique = Array.from(new Set(list));
      localStorage.setItem('relays', unique.join('\n'));
      const n = Math.max(1, Math.min(10, Number(countEl.value) || 3));
      localStorage.setItem('publishSubsetCount', String(n));
      publishSubsetCount = n;
      if (unique.length) {
        RELAYS = unique;
      }
      try {
        await ensureRelayConnections();
        showMessage('Settings saved');
      } catch (e) {
        console.error(e);
        showMessage('Saved, but failed to connect to some relays');
      }
    }

    async function testRelays() {
      const statusDiv = document.getElementById('relay-status');
      statusDiv.innerHTML = 'Testing...';
      const results = [];
      const timeout = (ms) => new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), ms));
      await Promise.allSettled(RELAYS.map(async (url) => {
        let relay;
        try {
          relay = NostrTools.relayInit(url);
          await Promise.race([relay.connect(), timeout(4000)]);
          results.push({ url, ok: true });
        } catch (e) {
          results.push({ url, ok: false });
        } finally {
          try { relay?.close(); } catch {}
        }
      }));
      statusDiv.innerHTML = results.map(r => `${r.ok ? '✅' : '❌'} ${r.url}`).join('<br>');
    }

    window.onload=async()=>{
      try{
        loadRelaysFromStorage();
        await ensureRelayConnections();
        loadBoards();
      }catch(e){
        console.error(e);
        showMessage('Failed to connect to relays');
      }
    };
  </script>
</body>
</html>